<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta content="text/html; charset=UTF-8" http-equiv="content-type" />
<title>OW random tournament</title>
<meta name="description" content="Overwatch random tournament">
<link rel="stylesheet" href="style.css">

<script src="ow_defines.js"></script>
<script src="common.js"></script>
<script src="owapi.js"></script>
<script src="stats_updater.js"></script>
<script src="import_export.js"></script>
<!--<script src="random_team_builder.js"></script>-->
<script src="ui.js"></script>

</head>

<script language="JavaScript" type="text/javascript">
var lobby = [];
var teams = [];

var player_being_added;
var player_being_edited;
var lobby_filter_timer = 0;
//var selected_player_team1 = "";

var Settings = get_default_settings();

/*var team_size = 6;
var region = "eu";*/

// player stats fetcher
/*var players_for_update = [];
var total_players_for_update = 0;
var min_api_request_interval = 6000; //milliseconds

var stat_update_fails = 0;
var silent_update = false; // show message when update completed successfully
var silent_update_errors = false; // show message when update failed

var stats_updater_ready = true; // set to false when update is done, but still need to wait for request interval before next update
var stats_update_max_retry = 2;
var stats_update_current_retry = 2;
var stats_update_dbg = false;*/


// init stats updater
StatsUpdater.onPlayerUpdated = on_player_stats_updated;
StatsUpdater.onComplete = on_stats_update_complete;
StatsUpdater.onStart = on_stats_update_start;
StatsUpdater.onProgressChange = on_stats_update_progress;
StatsUpdater.onError = on_stats_update_error;
StatsUpdater.onWarning = on_stats_update_warning;


// team builder
// RandomTeamBuilder object inside worker thread
var RtbWorker;


</script>

<body>

<div class="page-title">Overwatch random tournament</div>
<div class="copyright">2018 by <a href="https://github.com/adminimusRU">l33t m3at</a> | Stats data by <a href="https://github.com/SunDwarf/OWAPI">OWAPI</a></div>
<br/>

<br/>
<span style="color: green; text-shadow: 0 0 3px green; font: bold 22pt sans-serif; vertical-align: sub;">+</span>
<input id="new_player_id" name="new_player_id" type="text" size=35 placeholder="BattleTag" value="" onkeyup="new_player_keyup(event);"/> 
<button onclick="add_player_click();" id="add_btn" >Add player</button>
<br/>

<div class="table workspace">
	<div class="row">
		<div class="cell workspace-cell">
			<!-- lobby -->
			
			<div>
			<span class="team-title">Lobby</span>
			</div>
			
			<div class="team-toolbar">
			<input title="Clear lobby" type="button" class="team_btn" onclick="clear_lobby();" value=" X "/>
			<input title="Import lobby" id="import_lobby_btn" type="button" class="team_btn" onclick="import_lobby_dlg_open();" value="Import"/>
			<input title="Export lobby" type="button" class="team_btn" onclick="export_lobby_dlg_open();" value="Export"/>
			<input title="Sort lobby by SR" type="button" class="team_btn" onclick="sort_team(lobby, 'sr');redraw_teams();" value="&uarr;&darr;123"/>
			<input title="Sort lobby by name" type="button" class="team_btn" onclick="sort_team(lobby, 'display_name');redraw_teams();" value="&uarr;&darr;Az"/>
			</div>
					
			<span id="lobby_count">0</span> players<br/>
			
			<div style="display: flex;">
				<label for="lobby_filter">Filter: &nbsp;</label>
				<input id="lobby_filter" class="filter" type="text" size=35 autocomplete="off" placeholder="player name or battletag" value="" oninput="lobby_filter_change();"/> 
				<span onclick="lobby_filter_clear();" style="cursor: default;" title="Clear filter" alt="Clear filter"> &#9003; </span>
			</div>
			
			<div class="lobby-container">
				<div class="table team" id="lobby">

				</div>
			</div>
			
			<br/>
			<div title="Drop player here to delete" class="trashcan" id="trashcan" ondrop="player_drop(event)" ondragover="player_allowDrop(event)">				
				&#9760; Delete player (drop here)
			</div>
		</div>
		
		
		<div class="cell" style="width: 1em">
		<!-- spacer -->
		</div>
	
		<div class="cell workspace-cell main-toolbar">
			<!-- main toolbar -->
			
			<br/>
			<br/>
			<div >
				<input class="big-btn" type="button" id="roll_btn" onclick="roll_teams();" value="&#127922; Roll teams" title="Roll random teams from lobby"/>
				<br/>
				<br/>
				
				<input class="big-btn" type="button" onclick="add_empty_team();" value="&#10133; Add team" title="Add empty team"/>
				<br/>
				<br/>
				
				<input class="big-btn" type="button" onclick="export_teams_dlg_open();" value="Export teams"/>
				<br/>
				<br/>
				
				<input class="big-btn" type="button" onclick="reset_roll_click();" value="Reset" title="Move all players back to lobby"/>
				<br/>
				<br/>
								
				<br/>
				
								
				<input class="big-btn" type="button" id="settings_btn" onclick="settings_dlg_open();" value="&#9881; Settings" title="Open settings dialog"/>
				<br/>
				<br/>
				
				<br/>
				
				
				<input id="update_all_stats_btn" class="big-btn" type="button" onclick="update_all_stats();" value="&#8635; Update stats" title="Update stats for all players" />
				<input id="update_stats_stop_btn" class="big-btn" type="button" onclick="stop_stats_update();" value="Stop" style="display:none" />
				<div>
					<div id="stats_update_processing" style="text-align: center;">
						<progress id="stats_update_progress" value="0" max="100" style="width: 100%; visibility:hidden;">
						</progress>
					</div>
					<div id="stats_updater_status" style="min-height: 2em;">
						<!--Updating stats <br/> 123/456 randomlongbtag-->
					</div>
					
					<br/>
					<div id="stats_update_errors" style="color: red; visibility: hidden;">
						<span id="stats_update_errors_count">N</span> errors occurred.<br/>
						<a href="#" onclick="open_stats_update_log();">Click here to open log</a>
					</div>
				</div>
				<br/>
								
				
				<input class="medium-btn" type="button" onclick="generate_random_players();" value="+ random players" />
								
				<input class="medium-btn" type="button" onclick="generate_random_teams();" value="+ random teams" />
				<br/>
				<br/>
				
				<input class="medium-btn" type="button" onclick="test();" value="test" title=""/>
			</div>
			<br/>
			
		</div>
		
		<div class="cell" style="width: 1em">
		<!-- spacer -->
		</div>
		
		<div class="cell workspace-cell">
			<!-- rolled teams -->
			
			<div class="teams-container" id="teams_container">
				
				
				
			</div>
			
		</div>
	</div>
</div>

<div id="popup_dlg_import_lobby" class="dlg" style="display:none">
	<div class="dlg-background"></div>
	<div class="dlg-container">
		<div class="dlg-content">
			<span class="team-title">Import players</span>
			<input title="Close" type="button" class="team_btn dlg-close" onclick="close_dialog('popup_dlg_import_lobby');" value="X"/>
			<br/>
			<br/>
			<div id="dlg_player_import_format" class="dlg_options">
				<label for="dlg_player_import_format_value">Import format: </label>
				<select id="dlg_player_import_format_value">
					<option value="json">JSON (full info)</option>
					<option value="text">text (btag, [SR, class, offclass])</option>
				</select>
			</div>
						
			<textarea id="dlg_textarea_import_lobby" rows="20" cols="80"></textarea>
			
			<div>
			<input id="dlg_ok" class="big-btn" type="button" value="OK" onclick="import_lobby_ok();"/>
			</div>
		</div>
	</div>
</div>	
			

<div id="popup_dlg_export_lobby" class="dlg" style="display:none">
	<div class="dlg-background"></div>
	<div class="dlg-container">
		<div class="dlg-content">
			<span class="team-title">Export players</span>
			<input title="Close" type="button" class="team_btn dlg-close" onclick="close_dialog('popup_dlg_export_lobby');" value="X"/>
			<br/>
			<br/>
			
			<div id="dlg_player_export_format" class="dlg_options">
				<label for="dlg_player_export_format_value">Export format: </label>
				<select id="dlg_player_export_format_value">
					<option value="json">JSON (full info)</option>
					<option value="text">text (btags only)</option>
					<option value="csv">CSV (for Excel)</option>
				</select>
			</div>
					
			<textarea id="dlg_textarea_export_lobby" rows="20" cols="80"></textarea>
			
			<div>
				<input id="dlg_ok" class="big-btn" type="button" value="OK" onclick="export_lobby_ok();"/>
			</div>
		</div>
	</div>
</div>			
			

<div id="popup_dlg_export_teams" class="dlg" style="display:none">
	<div class="dlg-background"></div>
	<div class="dlg-container">
		<div class="dlg-content">
			<span class="team-title">Export teams</span>
			<input title="Close" type="button" class="team_btn dlg-close" onclick="close_dialog('popup_dlg_export_teams');" value="X"/>
			<br/>
			<br/>
			
			<div id="dlg_team_export_format" class="dlg_options">
				<label for="dlg_team_export_format_value">Format: </label>
				<select id="dlg_team_export_format_value" onchange="export_teams_dlg_change_format();">
					<option value="text-list">text list</option>
					<option value="html-table">HTML table</option>
				</select>
			</div>
			<div id="dlg_team_export_options" class="dlg_options" onchange="export_teams_dlg_change_format();">
				<input type="checkbox" id="dlg_team_export_players">
				<label for="dlg_team_export_players">Include players</label>
				<br/>
				<input type="checkbox" id="dlg_team_export_sr">
				<label for="dlg_team_export_sr">Include SR</label>
				<br/>
				<input type="checkbox" id="dlg_team_export_classes">
				<label for="dlg_team_export_classes">Include classes/roles</label>
				<br/>
				<label for="dlg_team_export_columns">Table columns</label>
				<input id="dlg_team_export_columns" type="number" min=1 max=999 value=1>
			</div>
			
			<textarea id="dlg_textarea_export_teams" rows="20" cols="80"></textarea>
			<div id="dlg_html_export_teams" class="html-export-container"></div>
			<div id="dlg_html_export_teams_hint" style="text-align: left;">
				<br/>
				<a href="#" onclick="export_teams_dlg_copy_html();">Click here</a> to copy teams table to clipboard. Paste to Excel or Google Sheets.
				<br/>
				<br/>
			</div>
			
			<div>
				<input id="dlg_ok" class="big-btn" type="button" value="OK" onclick="close_dialog('popup_dlg_export_teams');"/>
			</div>
		</div>
	</div>
</div>			
			
			
<div id="popup_dlg_edit_player" class="dlg" style="display:none">
	<div class="dlg-background"></div>
	<div class="dlg-container">
		<div class="dlg-content">
			<span id="dlg_title_edit_player" class="team-title">Player name</span>
			<input id="dlg_close" title="Close" type="button" class="team_btn dlg-close" onclick="close_dialog('popup_dlg_edit_player'); player_being_edited=undefined;" value="X"/>
			<br/>
			<br/>			
			
			<div id="dlg_player_edit" class="dlg_options table">
				<div class="row">
					<div class="cell">BattleTag:</div>
					<div class="cell"><a href="" id="dlg_player_id"></a></div>
				</div>
				<div class="row">
					<div class="cell"><label for="dlg_player_display_name">Name:</label></div>
					<div class="cell">
						<input id="dlg_player_display_name" type="text">
						<span id="dlg_player_name_edited" class="dlg-edited-mark" title="Name was manually edited" onclick="clear_edited_mark('ne');">&#9997;</span>
					</div>
				</div>
				<div class="row">
					<div class="cell"><label for="dlg_player_level">Level:</label></div>
					<div class="cell"><input id="dlg_player_level" type="text" readonly></div>
				</div>
				<div class="row">
					<div class="cell"><label for="dlg_player_sr">SR:</label></div>
					<div class="cell">
						<input id="dlg_player_sr" type="number" min=0 max=5000>
						<span id="dlg_player_sr_edited" class="dlg-edited-mark" title="SR was manually edited" onclick="clear_edited_mark('se');">&#9997;</span>
					</div>
				</div>
			</div>
			<div id="dlg_class_select" class="dlg_options table">
				<div class="row">
					<div class="cell">Main class: </div>
					<div class="cell">
						<select id="dlg_main_class">
							<option value="dps">dps</option>
							<option value="tank">tank</option>
							<option value="support">support</option>
						</select>
						<span id="dlg_player_class1_edited" class="dlg-edited-mark" title="Classes were manually edited" onclick="clear_edited_mark('ce');">&#9997;</span>
					</div>
				</div>
				<div class="row">
					<div class="cell">Secondary class: </div>
					<div class="cell">
						<select id="dlg_secondary_class">
							<option value="">-</option>
							<option value="dps">dps</option>
							<option value="tank">tank</option>
							<option value="support">support</option>
						</select>
						<span id="dlg_player_class2_edited" class="dlg-edited-mark" title="Classes were manually edited" onclick="clear_edited_mark('ce');">&#9997;</span>
					</div>
				</div>	
			</div>
			<div id="dlg_top_heroes">
				<br/>
				<span>Top heroes:</span>
				<br/>
				<div id="dlg_top_heroes_icons" class="hero-icon-list"></div>
			</div>
			
			<div style="text-align: left;">
				<br/>
				Stats last updated <span id="dlg_edit_player_last_updated"></span>
				<br/>
				<input id="dlg_update_player_stats" class="big-btn" type="button" value="&#8635; Update stats" onclick="update_current_player_stats();"/>
				<br/>
				<!--<div style="margin-top: 1em;">
										
				</div>-->
			</div>
			<br/>
			
			<div style="height: 2em; vertical-align: middle; text-align: center;">
				<div id="dlg_update_player_stats_loader" class="loader inline-loader" style="display: none;"></div>
				<div id="dlg_edit_player_update_result" style="display: none;"></div>
			</div>
			
			<br/>

			<div>
				<input id="dlg_ok" class="big-btn" type="button" value="OK" onclick="edit_player_ok();"/>
			</div>
		</div>
	</div>
</div>

<div id="popup_dlg_settings" class="dlg" style="display:none">
	<div class="dlg-background"></div>
	<div class="dlg-container">
		<div class="dlg-content">
			<span class="team-title">Settings</span>
			<input  title="Close" type="button" class="team_btn dlg-close" onclick="close_dialog('popup_dlg_settings');" value="X"/>
			<br/>
			<br/>	
			
			<div id="dlg_settings">
				<div class="group">
					<div class="group-header">
						Main
					</div>
					<div class="group-content">
						<div class="table">
							<div class="row">
								<div class="cell">
									Team size &nbsp;
								</div>
								<div class="cell">
									<input id="team_size" name="team_size" type="number" size=3 min=1 max=12 style="width: 3em;" value=""/> players
								</div>
							</div>
						</div>
					</div>
				</div>
				
				</br>
				
				<div class="group">
					<div class="group-header">
						Roll
					</div>
					<div class="group-content">
						<input type="checkbox" id="roll_adjust_sr" onchange="roll_adjust_sr_change();">
						<label for="roll_adjust_sr">Adjust player SR by main class</label>
						</br>
						<div class="subgroup" id="roll_adjust_sr_sub">
							<img src="class_icons/tank.png" style="height: 1em;"/>
							<input disabled id="roll_adjust_tank" class="percent" type="number" size=3 min=0 max=999 autocomplete="off" value="100"/>
							% &nbsp;
							
							<img src="class_icons/dps.png" style="height: 1em;"/>
							<input disabled id="roll_adjust_dps" class="percent" type="number" size=3 min=0 max=999 autocomplete="off" value="120"/>
							% &nbsp;
							
							<img src="class_icons/support.png" style="height: 1em;"/>
							<input disabled id="roll_adjust_support" class="percent" type="number" size=3 min=0 max=999 autocomplete="off" value="80"/>
							%  </br>
						</div>
																	
						<div class="range-title">Balance priority</div>
						<input id="roll_balance_priority" type="range" size=3 min=0 max=100 autocomplete="off" value="70" style="width:90%"/>
						</br>
						<div class="range-sub-container">
							<div class="range-sub range-sub-left">equal SR</div>
							<div class="range-sub range-sub-right">equal classes</div>
						</div>
												
						<div class="range-title">Roll quality</div>
						<input id="roll_quality" type="range" size=3 min=0 max=100 autocomplete="off" value="70" style="width:90%"/>
						</br>
						<div class="range-sub-container">
							<div class="range-sub range-sub-left">fast, poor balance</div>
							<div class="range-sub range-sub-right">slow, best balance</div>
						</div>
												
						<div class="range-title">Roll coverage</div>
						<input id="roll_coverage" type="range" size=3 min=0 max=100 autocomplete="off" value="50" style="width:90%"/>
						</br>
						<div class="range-sub-container">
							<div class="range-sub range-sub-left">some players benched, only balanced teams</div>
							<div class="range-sub range-sub-right">all participate, some teams poorly balanced</div>
						</div>
												
						<input type="checkbox" id="roll_team_count_power2">
						<label for="roll_team_count_power2">Team count should be 2<sup>n</sup> (for better bracket)</label>
						</br>
						
						<input type="checkbox" id="roll_separate_otps">
						<label for="roll_separate_otps">Do not place similar one-trick ponies into same team</label>
						</br>
						
					</div>
				</div>
				
				</br>
				
				<div class="group">
					<div class="group-header">
						Stats
					</div>
					<div class="group-content">
					
						Region &nbsp;
						<select id="region">
							<option value="eu">EU</option>
							<option value="us">US</option>
							<option value="kr">KR</option>
						</select>
						</br>
					
						<input type="checkbox" id="update_sr" checked>
						<label for="update_sr">Update player SR</label>
						</br>
						<input type="checkbox" id="update_class" checked>
						<label for="update_class">Update player class</label>
						</br>
						<input type="checkbox" id="update_edited_fields">
						<label for="update_edited_fields">Force update manually edited fields (name, SR, class)</label>
					</div>
				</div>
				<br/>
			</div>
			
			<div style="padding-bottom: 1em;">
				<input id="dlg_reset" class="big-btn" type="button" value="Restore defaults" onclick="reset_settings();"/>
			</div>
			<div>
				<input id="dlg_ok" class="big-btn" type="button" value="OK" onclick="apply_settings();"/>
			</div>
		</div>
	</div>
</div>		


<div id="popup_dlg_roll_progress" class="dlg" style="display:none">
	<div class="dlg-background"></div>
	<div class="dlg-container">
		<div class="dlg-content">
			<span class="team-title">Rolling teams</span>
			
			<br/>
			<br/>
			
			<div id="dlg_roll_progress">
				<progress id="roll_progress_bar" value="0" max="100" style="width: 80%;"></progress>
				<br/>
				<br/>
				<div id="dlg_roll_progress_text"></div>
				<br/>
				<br/>
				<input id="dlg_roll_cancel" class="big-btn" type="button" value="Cancel" onclick="cancel_roll();"/>
			</div>
		</div>
	</div>
</div>


<div id="popup_dlg_stats_update_init" class="dlg" style="display:none">
	<div class="dlg-background"></div>
	<div class="dlg-container">
		<div class="dlg-content">
			<span class="team-title">Update stats</span>
			<input  title="Close" type="button" class="team_btn dlg-close" onclick="close_dialog('popup_dlg_stats_update_init');" value="X"/>
			<br/>
			<br/>
			
			<div style="width:25em; text-align: left;">
				Update stats older than <span style="color:blue;" id="dlg_stats_update_days">0</span> days
				</br>
				
				<input id="stats_update_limit" type="range" size=3 min=0 max=100 autocomplete="off" value="43" style="width:90%" oninput="on_stats_update_limit_change();"/>
				</br>
				</br>
				
				Stats older than <span id="dlg_stats_update_date">0</span> will be updated.
							
			</div>
			</br>
			</br>
			
			<div>
				<input id="dlg_ok" class="big-btn" type="button" value="OK" onclick="update_stats_ok();"/>
			</div>
			
		</div>
	</div>
</div>


<div id="popup_dlg_stats_log" class="dlg" style="display:none">
	<div class="dlg-background"></div>
	<div class="dlg-container">
		<div class="dlg-content">
			<span class="team-title">Stats updater log</span>
			<input title="Close" type="button" class="team_btn dlg-close" onclick="close_dialog('popup_dlg_stats_log');" value="X"/>
			<br/>
			<br/>
									
			<textarea readonly id="stats_update_log" rows="20" cols="80" autocomplete="off"></textarea>
			
			<div style="padding-bottom: 1em;">
				<input id="dlg_reset" class="big-btn" type="button" value="Clear log" onclick="clear_stats_update_log();close_dialog('popup_dlg_stats_log');"/>
			</div>
			
		</div>
	</div>
</div>


<div id="debug_log"></div>

<script>
//restore saved players to teams
restore_saved_teams();

// restore settings
var saved_settings_json = localStorage.getItem("settings");
if ( saved_settings_json != null ) {
	var saved_settings = JSON.parse(saved_settings_json);
	for ( var i in Settings ) {
		if ( saved_settings[i] !== undefined ) {
			Settings[i] = saved_settings[i];
		}
	}
}
apply_stats_updater_settings();


/*var settings_list = [
	"team_size",
	"region",
	"balance_adjust_sr",
	"balance_adjust_sr_dps",
	"balance_adjust_sr_tank",
	"balance_adjust_sr_support",
	"balance_class_uneveness_value",
	"balance_separate_otps",
	"update_class",
	"update_sr",
	"update_edited_fields",
	"update_picked",
	"dlg_setup_format",
	"dlg_setup_share_sr",
	"dlg_setup_share_classes"
	];

for ( i in settings_list ) {
	var setting_value = localStorage.getItem(settings_list[i]);
	if( setting_value !== null ) {
		var setting_input = document.getElementById(settings_list[i]);
		if ( setting_input.type == "checkbox" ) {
			setting_input.checked = (setting_value == 'true');
		} else if ( setting_input.type == "text" ) {
			setting_input.value = setting_value;
		} else if ( setting_input.type == "number" ) {
			setting_input.value = Number(setting_value);
		} else if ( setting_input.type == "range" ) {
			setting_input.value = Number(setting_value);
		}
		
		if (StatsUpdater.hasOwnProperty(settings_list[i])) {
			StatsUpdater[settings_list[i]] = setting_value;
		}
	}
}

// set default values to inputs
if (document.getElementById("team_size").value == 0 ) {
	document.getElementById("team_size").value = team_size;
}
if (document.getElementById("region").value == "" ) {
	document.getElementById("region").value = region;
}

apply_team_size();
apply_region();
apply_adjust_sr_change();*/


// adjust lobby margin to account scrollbar width
var lobby_container = document.getElementsByClassName("lobby-container").item(0);
lobby_container.style.marginRight = "-"+get_scrollbar_width()+"px";
lobby_container.style.paddingRight = ""+get_scrollbar_width()+"px";

</script>
</body>
</html>
